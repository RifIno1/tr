<?php

require(APP_PATH . "config.php");

$link = mysql_connect($AppConfig['db']['host'], $AppConfig['db']['user'], $AppConfig['db']['password']);
if (!$link) {
    die('Could not connect: ' . mysql_error());
}

$db_selected = mysql_select_db($AppConfig['db']['database'], $link);
if (!$db_selected) {
    die('Can\'t use database: ' . mysql_error());
}

$playerId = $this->player->playerId;
$villageId = intval($this->data['selected_village_id']);

// Get the name of the selected village
$query = "SELECT village_name FROM p_villages WHERE id = $villageId LIMIT 1";
$result = mysql_query($query);
if (!$result) {
    die('Query failed: ' . mysql_error());
}
$row = mysql_fetch_assoc($result);
$village_name = $row['village_name'];

// Count all villages of player
$query_all = "SELECT COUNT(*) AS village_count FROM p_villages WHERE player_id = $playerId AND is_oasis = 0";
$result_all = mysql_query($query_all);
if (!$result_all) {
    die('Query failed: ' . mysql_error());
}
$row_all = mysql_fetch_assoc($result_all);
$num_rows_all = $row_all['village_count'];

// Calculate costs
$cost_for_one = 0.5;
$cost_for_all = $num_rows_all * 0.5;

$can_buy_forOne = floor($this->data['gold_num'] / $cost_for_one);
$can_buy_forAll = floor($this->data['gold_num'] / $cost_for_all);

?>
<br>
<h2>شراء النقاط الحضرية</h2>
<form action="" method="post">
<table class="troops">
    <thead>
        <tr>
            <th>#</th>
            <th style="padding:8px 2px">القرى</th>
            <th>التكلفة لكل 1 نقطة</th>
            <th>شراء</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td style="padding:6px 2px">
                <input type="radio" name="village" value="1" checked="checked" />
            </td>
            <td style="padding:6px 2px">
                <?php echo htmlspecialchars($village_name); ?>
            </td>
            <td>
                <?php echo $cost_for_one; ?> <img src="assets/x.gif" class="gold" title="الذهب" alt="" />
            </td>
            <td>
                <input class="text" type="text" name="cpOne" id="cpOne" value="0" />
                <a href="#" onclick="WriteValueInInput()">(<?php echo $can_buy_forOne; ?>)</a>
            </td>
        </tr>
        <tr>
            <td style="padding:6px 2px">
                <input type="radio" name="village" value="2" />
            </td>
            <td style="padding:6px 2px">
                جميع القرى
            </td>
            <td>
                <?php echo $cost_for_all; ?> <img src="assets/x.gif" class="gold" title="الذهب" alt="" />
            </td>
            <td>
                <input class="text" type="text" name="cpAll" id="cpAll" value="0" />
                <a href="#" onclick="WriteValueInInput2()">(<?php echo $can_buy_forAll; ?>)</a>
            </td>
        </tr>
    </tbody>
</table>

<br><br>
<center>
    <button type="submit" style="
        padding: 1px;
        border-radius: 5px;
        padding-left: 20px;
        padding-right: 20px;
        border: 1px solid #71d000;
        background-image: linear-gradient(to bottom, #fdfdfd, #c6c6c6);
        cursor: pointer;
        color: #7a7a7a;
        text-align: center;
        font-weight: 700;
        text-shadow: none;
    "
    name="s1" id="btn_ok" value="ok" onclick="this.style.visibility='hidden';">
        شراء
    </button>
</center>
</form>
<script type="text/javascript">
    function WriteValueInInput() {
        document.getElementById('cpOne').value = <?php echo $can_buy_forOne; ?>;
    }

    function WriteValueInInput2() {
        document.getElementById('cpAll').value = <?php echo $can_buy_forAll; ?>;
    }
</script>

<?php

// if button is clicked
if (isset($_POST['s1'])) {

    // Initialize variables
    $forOne = false;

    // Sanitize input to prevent SQL injection
    $village = intval($_POST['village']);
    $cp = 0; // Initialize cp variable to avoid undefined variable notice

    // Check which radio button is selected
    if ($village == 1) {
        $cp = intval($_POST['cpOne']);
        $cost = $cost_for_one * $cp;
        $forOne = true;
    } else {
        $cp = intval($_POST['cpAll']);
        $cost = $cost_for_all * $cp;
    }

    // Check if the player has enough gold
    if ($this->data['gold_num'] < $cost) {
        echo "<br><center><font color='red'>ليس لديك الذهب الكافي</font></center>";
    } else {

        // Update the player's gold
        $new_gold = $this->data['gold_num'] - $cost;
        $query = "UPDATE p_players SET gold_num = $new_gold WHERE id = $playerId";
        $result = mysql_query($query);

        if (!$result) {
            die('Query failed: ' . mysql_error());
        }

        // Update the village's cp
        if ($forOne) {
            // Get the old 
            echo $villageId;
            $queryCp = "SELECT cp FROM p_villages WHERE id = $villageId";
            $resultCp = mysql_query($queryCp);

            if ($resultCp) {
                $rowCp = mysql_fetch_assoc($resultCp);
                $old_cp = explode(" ", $rowCp['cp']);
                $old_cp[0] += $cp;
                $new_cp = mysql_real_escape_string($old_cp[0] . " " . $old_cp[1]);
                $query = "UPDATE p_villages SET cp = '$new_cp' WHERE id = $villageId";
                $result = mysql_query($query);
                if (!$result) {
                    die('Query failed: ' . mysql_error());
                }
            } else {
                die('Query failed: ' . mysql_error());
            }
        } else {
            // Get all villages of player
            // Initial query to get all villages with player_id and not an oasis
$query = "SELECT id FROM p_villages WHERE player_id = $playerId AND is_oasis = 0";
$result = mysql_query($query);

if ($result) {
    while ($row = mysql_fetch_assoc($result)) {
        // Query to get the cp value for the current village
        $query_cp = "SELECT cp FROM p_villages WHERE id = " . $row['id'];
        $result_cp = mysql_query($query_cp);
        
        if (!$result_cp) {
            die('Query failed: ' . mysql_error());
        }
        
        $cp_row = mysql_fetch_assoc($result_cp);
        $old_cp = explode(" ", $cp_row['cp']);
        $old_cp[0] += $cp;
        $new_cp = mysql_real_escape_string($old_cp[0] . " " . $old_cp[1]);
        
        // Output the new cp value (for debugging purposes)
        echo $new_cp;
        
        // Update the cp value in the database
        $query_update = "UPDATE p_villages SET cp = '$new_cp' WHERE id = " . $row['id'];
        $result_update = mysql_query($query_update);
        
        if (!$result_update) {
            die('Query failed: ' . mysql_error());
        }
    }
}
 else {
                die('Query failed: ' . mysql_error());
            }
        }

        echo "<br><center><font color='green'>تم شراء النقاط الحضرية بنجاح</font></center>";
    }
}
